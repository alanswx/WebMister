!function(e){e.richFilemanagerPlugin=function(t,i){var r=this,o=e(t),n=o.children(".fm-wrapper"),s=n.find(".fm-header"),a=s.find(".fm-uploader"),l=n.children(".fm-splitter"),d=n.children(".fm-footer"),c=l.children(".fm-fileinfo"),u=l.children(".fm-filetree"),p=c.find(".view-items-wrapper"),f=c.find(".fm-preview-wrapper"),h=p.find(".view-items"),m=a.children(".fm-upload"),v=null,b="/",g=null,w=[],y=null,M=null,k=null,C=null,x=null,S=null,j=null,L=purl(),_=(new Date).getTime();r.settings=e.extend(!0,{baseUrl:".",config:{},callbacks:{beforeCreateImageUrl:function(e,t){return t},beforeCreatePreviewUrl:function(e,t){return t},beforeSelectItem:function(e,t){return t},afterSelectItem:function(e,t,i){},beforeSetRequestParams:function(e,t){return t},beforeSendRequest:function(e,t){return!0}}},i),r.write=function(t,i){var r=alertify,o=e.extend({},{reset:!0,delay:5e3,logMaxItems:5,logPosition:"bottom right",logContainerClass:"fm-log",logMessageTemplate:null,parent:document.body,onClick:void 0,unique:!1,type:"log"},i);if(o.logClass&&o.unique&&e(".fm-log").children("."+o.logClass).length>0)return r;o.reset&&r.reset(),r.parent(o.parent),r.logDelay(o.delay),r.logMaxItems(o.logMaxItems),r.logPosition(o.logPosition),r.logContainerClass(o.logContainerClass),r.logMessageTemplate(o.logMessageTemplate),r[o.type](t,o.onClick);var n=r.getLogs();return n[n.length-1]},r.error=function(t,i){return r.write(t,e.extend({},{type:"error",delay:1e4},i))},r.warning=function(t,i){return r.write(t,e.extend({},{type:"warning",delay:1e4},i))},r.success=function(t,i){return r.write(t,e.extend({},{type:"success",delay:6e3},i))},r.alert=function(e){alertify.reset().dialogContainerClass("fm-popup").alert(e)},r.confirm=function(e){alertify.reset().dialogWidth(e.width).dialogPersistent(e.persistent).dialogContainerClass("fm-popup").confirm(e.message,e.okBtn,e.cancelBtn)},r.prompt=function(e){alertify.reset().dialogWidth(e.width).dialogPersistent(e.persistent).dialogContainerClass("fm-popup").theme(e.template).prompt(e.message,e.value||"",e.okBtn,e.cancelBtn)},r.dialog=function(e){alertify.reset().dialogWidth(e.width).dialogPersistent(e.persistent).dialogContainerClass("fm-popup").dialog(e.message,e.buttons)},r.setDimensions=function(){var t=n.outerHeight(!0)-n.height(),i=e(window).height()-s.height()-d.height()-t,r=l.width()-l.children(".splitter-bar-vertical").outerWidth()-u.outerWidth();l.height(i),c.width(r)},r.console=function(){v.options.logger&&arguments&&([].unshift.call(arguments,(new Date).getTime()),console.log.apply(this,arguments))},r.refreshFolder=function(e){k.loadPath(k.currentPath(),e)},r.loadFolder=function(e,t){e="/"+Z(e,"/")+"/",k.loadPath(e,t)};var E=function(){return e.when(R("default"),R("user")).done(function(t,i){var r=t[0],o=i[0];if(void 0!==o&&null!==o&&delete o.version,(v=e.extend({},r,o)).api.connectorUrl)g=v.api.connectorUrl;else{var n=location.origin+location.pathname,s="connectors/"+v.api.lang+"/filemanager."+v.api.lang;ne(n).length>0&&(n=n.substring(0,n.lastIndexOf("/")+1)),g=n+s}})},N=function(){return we("GET",{mode:"initiate"}).done(function(t){if(t.data){var i=t.data.attributes.config;e.each(i,function(t,i){e.each(i,function(e,i){if(null===i)return!0;void 0===v[t]&&(v[t]=[]),v[t][e]=i})}),v.security.readOnly&&(v.options.browseOnly=!0)}}).fail(function(e){r.error("Unable to perform initial request to server."),$(e)}).then(function(t){if(t.errors)return e.Deferred().reject()})},I=function(){return C=new T,e.ajax().then(function(){var e=L.param("langCode");if(e)return B(C.buildLangFileUrl(e)).done(function(){C.setLang(e)}).fail(function(){setTimeout(function(){r.error("Given language file ("+C.buildLangFileUrl(e)+") does not exist!")},500)});C.setLang(v.language.default)}).then(function(){return e.ajax({type:"GET",url:C.buildLangFileUrl(C.getLang()),dataType:"json"}).done(function(e){C.setTranslations(e)})}).then(function(){var t=C.getLang().substr(0,2),i=r.settings.baseUrl;return e.when(e.get(i+"/scripts/cldrjs/cldr-dates/"+t+"/ca-gregorian.json"),e.get(i+"/scripts/cldrjs/cldr-numbers/"+t+"/numbers.json"),e.get(i+"/scripts/cldrjs/cldr-core/supplemental/likelySubtags.json"),e.get(i+"/scripts/cldrjs/cldr-core/supplemental/timeData.json"),e.get(i+"/scripts/cldrjs/cldr-core/supplemental/weekData.json")).fail(function(){r.error('CLDR files for "'+t+'" language do not exist!')}).then(function(){return[].slice.apply(arguments,[0]).map(function(e){return e[0]})}).then(Globalize.load).then(function(){x=Globalize(t)})})},O=function(){return e.when(W("upload-container"),W("upload-item")).done(function(e,t){var i=e[0],r=t[0];n.append(i).append(r)})},P=function(e){var t=[],i=[];if(t.push("/themes/"+v.options.theme+"/styles/theme.css"),v.viewer.image.lazyLoad&&t.push("/scripts/lazyload/dist/lazyload.min.js"),v.customScrollbar.enabled&&(t.push("/scripts/custom-scrollbar-plugin/jquery.mCustomScrollbar.min.css"),t.push("/scripts/custom-scrollbar-plugin/jquery.mCustomScrollbar.concat.min.js")),t.push(e),H(t),v.editor.enabled){var r=v.editor.theme;r&&"default"!==r&&i.push("/scripts/CodeMirror/theme/"+r+".css"),i.push("/scripts/CodeMirror/lib/codemirror.css"),i.push("/scripts/CodeMirror/lib/codemirror.js"),i.push("/scripts/CodeMirror/addon/selection/active-line.js"),i.push("/scripts/CodeMirror/addon/display/fullscreen.css"),i.push("/scripts/CodeMirror/addon/display/fullscreen.js")}v.viewer.markdownRenderer.enabled&&(i.push("/styles/fm-markdown.css"),i.push("/scripts/markdown-it/markdown-it.min.js"),i.push("/scripts/markdown-it/default.min.css"),i.push("/scripts/markdown-it/highlight.min.js"),i.push("/scripts/markdown-it/markdown-it-footnote.min.js"),i.push("/scripts/markdown-it/markdown-it-replace-link.min.js")),v.options.browseOnly||(i.push("/scripts/jQuery-File-Upload/js/vendor/jquery.ui.widget.js"),i.push("/scripts/jQuery-File-Upload/js/canvas-to-blob.min.js"),i.push("/scripts/jQuery-File-Upload/js/load-image.all.min.js"),i.push("/scripts/jQuery-File-Upload/js/jquery.iframe-transport.js"),i.push("/scripts/jQuery-File-Upload/js/jquery.fileupload.js"),i.push("/scripts/jQuery-File-Upload/js/jquery.fileupload-process.js"),i.push("/scripts/jQuery-File-Upload/js/jquery.fileupload-image.js"),i.push("/scripts/jQuery-File-Upload/js/jquery.fileupload-validate.js"),v.upload.multiple&&i.push("/scripts/jQuery-File-Upload/css/dropzone.css")),i.length&&H(i)},F=function(){S=new D,w=v.options.capabilities||["upload","select","download","rename","copy","move","delete","extract","createFolder"];var t=[];v.options.fileSorting&&(t=v.options.fileSorting.toLowerCase().split("_")),y=t[0]||"name",M=t[1]||"asc";var i=L.param("exclusiveFolder");i&&(b=oe(b="/"+i+"/"));var s=L.param("expandedFolder");if(s&&(j=oe(j=b+s+"/")),k=new z,ko.applyBindings(k),k.itemsModel.initiateLazyLoad(),k.filterModel.setName(L.param("filter")),ko.bindingHandlers.toggleNodeVisibility={init:function(t,i){var r=i();e(t).toggle(r.isExpanded())},update:function(t,i){var r=i();if(!1===r.isSliding())return!1;!1===r.isExpanded()&&e(t).slideDown(v.filetree.expandSpeed,function(){r.isSliding(!1),r.isExpanded(!0)}),!0===r.isExpanded()&&e(t).slideUp(v.filetree.expandSpeed,function(){r.isSliding(!1),r.isExpanded(!1)})}},ko.bindingHandlers.draggableView={init:function(e,t,i){k.ddModel.makeDraggable(t(),e)}},ko.bindingHandlers.droppableView={init:function(e,t,i){k.ddModel.makeDroppable(t(),e)}},ko.bindingHandlers.draggableTree={init:function(e,t,i){k.ddModel.makeDraggable(t(),e)}},ko.bindingHandlers.droppableTree={init:function(e,t,i){k.ddModel.makeDroppable(t(),e)}},n.mousewheel(function(t){if(!k.ddModel.dragHelper)return!0;var i=null;if((v.customScrollbar.enabled?e([p[0],u[0]]):l.children(".splitter-pane")).each(function(r){var o=e(this),n=o.offset().top,s=o.offset().left;if(t.offsetY>=n&&t.offsetY<=n+o.height()&&t.offsetX>=s&&t.offsetX<=s+o.width())return i=o,!1}),null===i)return!1;if(v.customScrollbar.enabled){var r=i.find(".mCSB_scrollTools_vertical"),o=1===t.deltaY?"+":"-";r.is(":visible")&&i.mCustomScrollbar("scrollTo",[o+"=250",0],{scrollInertia:500,scrollEasing:"easeOut",callbacks:!0})}else if(i[0].scrollHeight>i[0].clientHeight){var n=i.scrollTop()-200*t.deltaY;k.ddModel.isScrolling=!0,n=n<0?0:n,i.stop().animate({scrollTop:n},100,"linear",function(){k.ddModel.isScrolling=!1,k.ddModel.isScrolled=!0})}}),h.selectable({filter:"li:not(.directory-parent), tbody > tr:not(.directory-parent)",cancel:".directory-parent, thead",disabled:!v.manager.selection.enabled,appendTo:h,start:function(e,t){je(),k.itemsModel.isSelecting(!0)},stop:function(e,t){k.itemsModel.isSelecting(!1)},selected:function(e,t){ko.dataFor(t.selected).selected(!0)},unselected:function(e,t){ko.dataFor(t.unselected).selected(!1)}}),c.contextMenu({selector:".view-items",zIndex:10,build:function(t,i){var r={createFolder:{name:A("create_folder"),className:"create-folder"},paste:{name:A("clipboard_paste"),className:"paste",disabled:function(e,t){return k.clipboardModel.isEmpty()}}};return k.clipboardModel.enabled()&&!0!==v.options.browseOnly||delete r.paste,Q("createFolder")&&!0!==v.options.browseOnly||delete r.createFolder,!e.isEmptyObject(r)&&{appendTo:".fm-container",items:r,reposition:!1,callback:function(e,t){switch(e){case"createFolder":k.headerModel.createFolder();break;case"paste":k.clipboardModel.paste()}}}}}),v.extras.extra_js)for(var a=0;a<v.extras.extra_js.length;a++)e.ajax({type:"GET",url:v.extras.extra_js[a],dataType:"script",async:v.extras.extra_js_async});L.param("CKEditorCleanUpFuncNum")&&(k.headerModel.closeButton(!0),k.headerModel.closeButtonOnClick=function(){parent.CKEDITOR.tools.callFunction(L.param("CKEditorCleanUpFuncNum"))}),function(){if(!v.filetree.enabled)return;u.show(),l.splitter({sizeLeft:v.filetree.width,minLeft:v.filetree.minWidth,minRight:200})}(),We(),k.treeModel.loadDataNode(k.treeModel.rootNode,!0),v.customScrollbar.enabled&&(u.mCustomScrollbar({theme:v.customScrollbar.theme,scrollButtons:{enable:v.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0},callbacks:{onScrollStart:function(){k.ddModel.isScrolling=!0},onScroll:function(){k.ddModel.isScrolling=!1}},axis:"yx"}),f.mCustomScrollbar({theme:v.customScrollbar.theme,scrollButtons:{enable:v.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0,updateOnSelectorChange:".fm-preview-viewer"}}),p.mCustomScrollbar({theme:v.customScrollbar.theme,scrollButtons:{enable:v.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0,updateOnSelectorChange:".grid, .list"},callbacks:{onScrollStart:function(){k.itemsModel.continiousSelection()||(this.yStartPosition=this.mcs.top,this.yStartTime=(new Date).getTime()),k.ddModel.isScrolling=!0},onScroll:function(){k.ddModel.isScrolling=!1,k.ddModel.isScrolled=!0},whileScrolling:function(){if(v.manager.selection.enabled){var e=(new Date).getTime()-this.yStartTime;!k.itemsModel.continiousSelection()&&e>400&&(this.yStartPosition=this.mcs.top),k.itemsModel.isSelecting()&&k.itemsModel.continiousSelection(!0);var t=Math.abs(this.mcs.top)-Math.abs(this.yStartPosition);h.selectable("repositionCssHelper",t,0)}k.itemsModel.lazyLoad&&k.itemsModel.lazyLoad.handleScroll()}},axis:"y",alwaysShowScrollbar:0}));if(document.documentElement.setAttribute("data-useragent",navigator.userAgent),v.options.logger){var d=(new Date).getTime()-_;console.log("Total execution time : "+d+" ms")}o.find(".fm-loading-wrap").fadeOut(800,function(){r.setDimensions()}),r.setDimensions()},T=function(){var e=null,t={},i=r.settings.baseUrl+"/languages/";this.buildLangFileUrl=function(e){return i+e+".json"},this.setLang=function(t){e=t},this.getLang=function(){return e},this.setTranslations=function(e){t=e},this.getTranslations=function(){return t},this.translate=function(e){return t[e]}},D=function(){var e={},t=this;this.push=function(i,r,o){t.removeTimer(i),e[i]=setTimeout(r,o)},this.getTimer=function(t){return e[t]},this.removeTimer=function(t){e[t]&&(clearTimeout(e[t]),delete e[t])}},z=function(){var t=this;this.config=ko.observable(v),this.loadingView=ko.observable(!0),this.previewFile=ko.observable(!1),this.viewMode=ko.observable(v.manager.defaultViewMode),this.currentPath=ko.observable(b),this.browseOnly=ko.observable(v.options.browseOnly),this.previewModel=ko.observable(null),this.currentLang=C.getLang(),this.lg=C.getTranslations(),this.previewFile.subscribe(function(e){e||(t.previewModel.closeEditor(),t.itemsModel.descriptivePanel.rdo().id===t.previewModel.rdo().id&&t.itemsModel.descriptivePanel.render(t.previewModel.viewer.content()))}),this.isCapable=function(e){return Q(e)},this.loadPath=function(e,i){var r,o=new d(e);i&&(r=k.treeModel.findByParam("id",e)),r&&o.setPreloader(k.treeModel.getPreloader(r)),o.setPreloader(t.itemsModel.getPreloader()).setDataHandler(function(e,i){r&&k.treeModel.addNodes(e,r,!0),t.itemsModel.addItems(e,i,!0),t.searchModel.clearInput()}).load(function(){return Te(e)})},this.addElements=function(e,i,r){var o=t.treeModel.findByParam("id",i);o&&t.treeModel.addNodes(e,o,r),t.currentPath()===i&&t.itemsModel.addItems(e,i,r)},this.removeElement=function(e){var i=t.treeModel.findByParam("id",e.id);i&&i.remove();var r=t.itemsModel.findByParam("id",e.id);r&&r.remove()},this.fetchSelectedItems=function(e){var i,r;if(e===l.name)return t.itemsModel.getSelected();if(e===a.name)return t.treeModel.getSelected();if(!e)return i=t.treeModel.getSelected(),(r=t.itemsModel.getSelected()).length>0?r:i;throw new Error("Unknown item type.")},this.fetchSelectedObjects=function(i){var r=[];return e.each(t.fetchSelectedItems(i.constructor.name),function(e,t){r.push(t.rdo)}),r};function i(e){return(!v.manager.selection.enabled||!v.manager.selection.useCtrlKey||!0!==e.ctrlKey)&&(!v.manager.dblClickOpen||"click"!==e.type)}var s=function(){this.beforeLoad=function(e){},this.afterLoad=function(e,t){}},a=function(i){var o=this;this.id=i.id,this.rdo=i,this.cdo={isFolder:"folder"===i.type,extension:"file"===i.type?ne(i.id):null,dimensions:i.attributes.width?i.attributes.width+"x"+i.attributes.height:null,cssItemClass:"folder"===i.type?"directory":"file",hiddenByType:!1,hiddenBySearch:!1},this.visible=ko.observable(!0),this.nodeTitle=ko.observable(i.attributes.name),this.children=ko.observableArray([]),this.parentNode=ko.observable(null),this.isSliding=ko.observable(!1),this.isLoading=ko.observable(!1),this.isLoaded=ko.observable(!1),this.isExpanded=ko.observable(!1),this.selected=ko.observable(!1),this.dragHovered=ko.observable(!1),this.level=ko.observable(0),this.isFirstNode=ko.observable(!1),this.isLastNode=ko.observable(!1),this.nodeTitle.subscribe(function(e){o.rdo.attributes.name=e}),this.children.subscribe(function(e){t.treeModel.arrangeNode(o)}),this.isLoaded.subscribe(function(e){o.isLoading(!e)}),this.selected.subscribe(function(e){e?(null!==t.treeModel.selectedNode()&&t.treeModel.selectedNode().selected(!1),t.treeModel.selectedNode(o),t.itemsModel.unselectItems()):t.treeModel.selectedNode(null)}),this.switchNode=function(e){return!!e.cdo.isFolder&&(e.rdo.attributes.readable?void(e.isLoaded()?t.treeModel.toggleNode(e):o.openNode(e)):(r.error(A("NOT_ALLOWED_SYSTEM")),!1))},this.mouseDown=function(e,t){e.selected(!0)},this.nodeClick=function(e,t){v.manager.dblClickOpen||o.openNode(e)},this.nodeDblClick=function(e,t){v.manager.dblClickOpen&&o.openNode(e)},this.openNode=function(i,r){if("file"===i.rdo.type&&Be(i.rdo),"folder"===i.rdo.type)if(!i.isLoaded()||i.isExpanded()&&v.filetree.reloadOnClick)t.treeModel.loadDataNode(i,!0);else{t.treeModel.toggleNode(i);var o=[];e.each(i.children(),function(e,t){o.push(t.rdo)}),t.itemsModel.addItems(o,i.id,!0)}},this.remove=function(){o.parentNode().children.remove(o)},this.isRoot=function(){return o.level()===t.treeModel.rootNode.level()},this.title=ko.pureComputed(function(){return v.options.showTitleAttr?this.rdo.id:null},this),this.itemClass=ko.pureComputed(function(){var e=[];return this.selected()&&v.manager.selection.enabled&&e.push("ui-selected"),this.dragHovered()&&e.push(t.ddModel.hoveredCssClass),e.join(" ")},this),this.iconClass=ko.pureComputed(function(){var e,t=["ico"];return!0===this.cdo.isFolder?(e="ico_folder",!0===this.isLoading()?t.push("loading"):(t.push("folder"),this.rdo.attributes.readable?(this.isExpanded()||!this.isExpanded()&&this.isSliding())&&t.push("open"):t.push("lock"))):(e="ico_file",this.rdo.attributes.readable?t.push("ext",this.cdo.extension):t.push("file","lock")),e+" "+t.join("_")},this),this.switcherClass=ko.pureComputed(function(){var e=[];if(v.filetree.showLine?0===this.level()&&this.isFirstNode()&&this.isLastNode()?e.push("root"):0===this.level()&&this.isFirstNode()?e.push("roots"):this.isLastNode()?e.push("bottom"):e.push("center"):e.push("noline"),this.cdo.isFolder){var t=this.isExpanded()||!this.isExpanded()&&this.isSliding();e.push(t?"open":"close")}else e.push("docu");return e.join("_")},this),this.clusterClass=ko.pureComputed(function(){return v.filetree.showLine&&!this.isLastNode()?"line":""},this)},l=function(e){var r=v.viewer.image.thumbMaxWidth;e.attributes.width&&e.attributes.width<r&&(r=e.attributes.width),this.id=e.id,this.rdo=e,this.cdo={isFolder:"folder"===e.type,sizeFormatted:q(e.attributes.size),createdFormatted:G(e.attributes.created),modifiedFormatted:G(e.attributes.modified),extension:"file"===e.type?ne(e.id):null,dimensions:e.attributes.width?e.attributes.width+"x"+e.attributes.height:null,cssItemClass:"folder"===e.type?"directory":"file",imageUrl:ke(e,!0,!0),previewWidth:r,hiddenByType:!1,hiddenBySearch:!1},this.visible=ko.observable(!0),this.selected=ko.observable(!1),this.dragHovered=ko.observable(!1),this.lazyPreview=v.viewer.image.lazyLoad&&this.cdo.imageUrl,this.selected.subscribe(function(e){e&&null!==t.treeModel.selectedNode()&&t.treeModel.selectedNode().selected(!1)}),this.title=ko.pureComputed(function(){return v.options.showTitleAttr?this.rdo.id:null},this),this.itemClass=ko.pureComputed(function(){var e=[];return this.selected()&&v.manager.selection.enabled&&e.push("ui-selected"),this.dragHovered()&&e.push(t.ddModel.hoveredCssClass),this.cdo.cssItemClass+" "+e.join(" ")},this),this.listIconClass=ko.pureComputed(function(){var e,t=["ico"];return!0===this.cdo.isFolder?(e="ico_folder",t.push("folder"),this.rdo.attributes.readable||t.push("lock")):(e="ico_file",this.rdo.attributes.readable?t.push("ext",this.cdo.extension):t.push("file","lock")),e+" "+t.join("_")},this),this.gridIconClass=ko.pureComputed(function(){var e=[],t=["ico"];return this.cdo.imageUrl||(e.push("grid-icon"),!0===this.cdo.isFolder?(e.push("ico_folder"),t.push("folder"),this.rdo.attributes.readable||t.push("lock")):(e.push("ico_file"),this.rdo.attributes.readable?t.push("ext",this.cdo.extension):t.push("file","lock")),e.push(t.join("_"))),e.join(" ")},this),this.mouseDown=function(e,i){e.selected()||t.itemsModel.unselectItems(i.ctrlKey),t.selectionModel.unselect=e.selected(),e.selected(!0)},this.open=function(e,r){t.selectionModel.unselect&&(r.ctrlKey&&e.selected(!1),!r.ctrlKey&&v.manager.dblClickOpen&&(t.itemsModel.unselectItems(r.ctrlKey),e.selected(!0))),i(r)&&(v.options.quickSelect&&"file"===e.rdo.type&&Y(e.rdo,"select")?_e(e.rdo):Be(e.rdo))},this.remove=function(){t.itemsModel.objects.remove(this)}},d=function(t){var i=this,r=null,o=[];this.setPreloader=function(e){return o.push(e),i},this.setDataHandler=function(e){return r=e,i},this.load=function(i){o.forEach(function(e,i,r){e.beforeLoad(t)}),i().then(function(i){i.data&&(r(i.data,t),e.each(o,function(e,r){r.afterLoad(t,i)}))})}},u=function(){var t,i=this;this.rdo=ko.observable({}),this.content=ko.observable(null),this.renderer=ko.observable(null),this.render=function(e){i.renderer()&&i.renderer().processContent(e)},this.setRenderer=function(e){i.rdo(e),i.renderer((t=e.attributes.name,be(t)?new o:ve(t)?new r:void 0));var t},this.setContainer=function(r){e.each(r,function(){if(e(this).hasClass("fm-renderer-container"))return t=e(this),!1}),i.renderer().processDomElements(t)};var r=function(){this.name="codeMirror",this.interactive=!1;var e=new p;this.processContent=function(t){e.render(t),i.content(t)},this.processDomElements=function(t){if(!e.instance){var r=t.find(".fm-cm-renderer-content")[0],o=ne(i.rdo().id);e.createInstance(o,r,{readOnly:"nocursor",styleActiveLine:!1,lineNumbers:!1})}}},o=function(){this.name="markdown",this.interactive=!0;var r=window.markdownit({html:!0,linkify:!0,typographer:!0,highlight:function(e,t){if(t&&hljs.getLanguage(t))try{return'<pre class="highlight"><code>'+hljs.highlight(t,e,!0).value+"</code></pre>"}catch(e){}return'<pre class="highlight"><code>'+r.utils.escapeHtml(e)+"</code></pre>"},replaceLink:function(e,t){if(-1!=e.search("://")||ie(e,"mailto:"))return e;var r=(ie(e,"/")?b:se(i.rdo().id))+ee(e,"/");if(be(r))return r;var o=ge("GET",{mode:"readfile",path:r});return ye(o)}}).use(window.markdownitReplaceLink);this.processContent=function(o){var n=r.render(o);i.content(n),t.find("a").each(function(){var t=e(this).attr("href"),i=k.previewModel.editor;if(i.enabled()&&i.isInteractive())e(this).off("click"),e(this).on("click",function(){return!1});else{if(-1!=t.search("://")||ie(t,"mailto:"))return;be(t)&&e(this).on("click",function(e){return ze(t).then(function(e){e.data&&Be(e.data)}),!1})}})},this.processDomElements=function(e){}}},p=function(){var t=this,i=null;this.instance=null,this.enabled=ko.observable(!1),this.content=ko.observable(null),this.mode=ko.observable(null),this.isInteractive=ko.observable(!1),this.mode.subscribe(function(e){e&&(t.instance.setOption("mode",e),i&&(r(i),i=null))}),this.render=function(e){t.mode()?r(e):i=e},this.createInstance=function(i,r,o){var n,s={readOnly:"nocursor",styleActiveLine:!1,viewportMargin:1/0,lineNumbers:v.editor.lineNumbers,lineWrapping:v.editor.lineWrapping,theme:v.editor.theme,matchBrackets:v.editor.matchBrackets,extraKeys:{F11:function(e){e.setOption("fullScreen",!e.getOption("fullScreen"))},Esc:function(e){e.getOption("fullScreen")&&e.setOption("fullScreen",!1)}}};(n=CodeMirror.fromTextArea(r,e.extend({},s,o))).on("changes",function(e,i){t.content(e.getValue())}),t.instance=n,function(e){var i=[],r="default";v.editor.codeHighlight&&("js"===e&&(i.push("/scripts/CodeMirror/mode/javascript/javascript.js"),r="javascript"),"css"===e&&(i.push("/scripts/CodeMirror/mode/css/css.js"),r="css"),"html"===e&&(i.push("/scripts/CodeMirror/mode/xml/xml.js"),r="text/html"),"xml"===e&&(i.push("/scripts/CodeMirror/mode/xml/xml.js"),r="application/xml"),"php"===e&&(i.push("/scripts/CodeMirror/mode/htmlmixed/htmlmixed.js"),i.push("/scripts/CodeMirror/mode/xml/xml.js"),i.push("/scripts/CodeMirror/mode/javascript/javascript.js"),i.push("/scripts/CodeMirror/mode/css/css.js"),i.push("/scripts/CodeMirror/mode/clike/clike.js"),i.push("/scripts/CodeMirror/mode/php/php.js"),r="application/x-httpd-php"),"java"===e&&(i.push("/scripts/CodeMirror/mode/clike/clike.js"),r="text/x-java"),"sql"===e&&(i.push("/scripts/CodeMirror/mode/sql/sql.js"),r="text/x-mysql"),"md"===e&&(i.push("/scripts/CodeMirror/addon/mode/overlay.js"),i.push("/scripts/CodeMirror/mode/xml/xml.js"),i.push("/scripts/CodeMirror/mode/markdown/markdown.js"),i.push("/scripts/CodeMirror/mode/gfm/gfm.js"),i.push("/scripts/CodeMirror/mode/javascript/javascript.js"),i.push("/scripts/CodeMirror/mode/css/css.js"),i.push("/scripts/CodeMirror/mode/htmlmixed/htmlmixed.js"),i.push("/scripts/CodeMirror/mode/clike/clike.js"),i.push("/scripts/CodeMirror/mode/shell/shell.js"),i.push("/scripts/CodeMirror/mode/meta.js"),r="gfm"),"sh"===e&&(i.push("/scripts/CodeMirror/addon/mode/overlay.js"),i.push("/scripts/CodeMirror/mode/markdown/markdown.js"),i.push("/scripts/CodeMirror/mode/gfm/gfm.js"),i.push("/scripts/CodeMirror/mode/javascript/javascript.js"),i.push("/scripts/CodeMirror/mode/css/css.js"),i.push("/scripts/CodeMirror/mode/htmlmixed/htmlmixed.js"),i.push("/scripts/CodeMirror/mode/clike/clike.js"),i.push("/scripts/CodeMirror/mode/meta.js"),i.push("/scripts/CodeMirror/mode/shell/shell.js"),r="shell"));i.length?(i.push(function(){t.mode(r)}),H(i)):t.mode(r)}(i)};function r(e){t.enabled(!0),t.instance.setValue(e),setTimeout(function(){t.instance.refresh()},0)}};this.treeModel=new function(){var i=this;this.selectedNode=ko.observable(null);var r=new a({attributes:{}});r.id=b,r.level=ko.observable(-1),this.rootNode=r;this.mapNodes=function(e,t){t||(t=i.rootNode),t.isRoot()||e.call(this,t);var r=t.children();if(!r||0===r.length)return null;for(var o=0,n=r.length;o<n;o++)e.call(this,r[o]),i.findByFilter(e,r[o])},this.findByParam=function(e,t,r){if(!r&&(r=i.rootNode)[e]===t)return r;var o=r.children();if(!o||0===o.length)return null;for(var n=0,s=o.length;n<s;n++){if(o[n][e]===t)return o[n];var a=i.findByParam(e,t,o[n]);if(a)return a}return null},this.findByFilter=function(e,t){if(!t&&e(t=i.rootNode))return t;var r=t.children();if(!r||0===r.length)return null;for(var o=0,n=r.length;o<n;o++){if(e(r[o]))return r[o];var s=i.findByFilter(e,r[o]);if(s)return s}return null},this.getSelected=function(){var e=[];return i.selectedNode()&&e.push(i.selectedNode()),e},this.loadDataNode=function(e,r){var o=e.id;new d(o).setPreloader(t.itemsModel.getPreloader()).setPreloader(i.getPreloader(e)).setDataHandler(function(o,n){i.addNodes(o,e,r),t.itemsModel.addItems(o,n,r),t.searchModel.clearInput()}).load(function(){return Te(o)})},this.getPreloader=function(e){var t=function(){};return(t.prototype=Object.create(s)).beforeLoad=function(t){e.isRoot()||e.isLoaded(!1)},t.prototype.afterLoad=function(t,r){e.isRoot()||(e.isLoaded(!0),i.expandNode(e)),function(e){if(null!==j){e||(e=i.rootNode);var t=i.findByFilter(function(e){return 0===j.indexOf(e.id)},e);t?(v.filetree.expandSpeed=10,i.loadDataNode(t,!0)):(j=null,v.filetree.expandSpeed=200)}}(e)},new t},this.createNode=function(e){var t=new a(e);return k.filterModel.filterItem(t),t},this.createNodes=function(t){var r=[];return e.each(t,function(e,t){r.push(i.createNode(t))}),r},this.appendNodes=function(t,r){e.isArray(r)||(r=[r]),t||(t=i.rootNode),v.filetree.foldersOnly&&(r=e.grep(r,function(e){return e.cdo.isFolder})),e.each(r,function(e,i){i.parentNode(t)});var o=t.children().concat(r);t.children(U(o))},this.addNodes=function(t,r,o){if(e.isArray(t)||(t=[t]),r){var n=i.createNodes(t);o&&r.children([]),i.appendNodes(r,n)}},this.expandNode=function(e){return!1===e.isExpanded()&&!0===e.isLoaded()&&(e.isSliding(!0),!0)},this.collapseNode=function(e){return!0===e.isExpanded()&&(e.isSliding(!0),!0)},this.toggleNode=function(e){i.collapseNode(e)||i.expandNode(e)},this.arrangeNode=function(t){var i=t.children().length;e.each(t.children(),function(e,r){r.level(t.level()+1),r.isFirstNode(0===e),r.isLastNode(e===i-1)})},this.nodeRendered=function(i,r){e(i[1]).contextMenu({selector:".file, .directory",zIndex:100,build:function(e,i){return r.selected(!0),{appendTo:".fm-container",items:Re(r.rdo),callback:function(e,i){He(e,i,r.rdo,t.fetchSelectedObjects(r))}}}})},this.actualizeNodeObject=function(t,r,o){var n=new RegExp("^"+r),s=t.rdo.id,a=s.replace(n,o);t.id=a,t.rdo.id=a,t.rdo.attributes.path=t.rdo.attributes.path.replace(new RegExp(s+"$"),a),t.children().length&&e.each(t.children(),function(e,t){i.actualizeNodeObject(t,r,o)})}},this.itemsModel=new function(){var o=this;this.objects=ko.observableArray([]),this.parentItem=ko.observable(null),this.objectsSize=ko.observable(0),this.objectsNumber=ko.observable(0),this.selectedNumber=ko.observable(0),this.listSortField=ko.observable(y),this.listSortOrder=ko.observable(M),this.isSelecting=ko.observable(!1),this.continiousSelection=ko.observable(!1),this.descriptivePanel=new u,this.lazyLoad=null,this.isSelecting.subscribe(function(e){e||o.continiousSelection(!1)}),this.createItem=function(e){var t=new l(e);return k.filterModel.filterItem(t),t},this.createItems=function(t){var i=[];return e.each(t,function(e,t){i.push(o.createItem(t))}),i},this.appendItems=function(t){e.isArray(t)||(t=[t]);var i=o.objects().concat(t);o.objects(U(i))},this.addItems=function(i,r,n){e.isArray(i)||(i=[i]);var s=o.createItems(i);n?(t.currentPath(r),t.breadcrumbsModel.splitCurrent(),o.setDescriptivePanel(i),o.setItemsList(s),o.addParentItem()):o.appendItems(s)},this.loadDataList=function(e){new d(e).setPreloader(o.getPreloader()).setDataHandler(function(e,i){o.addItems(e,i,!0),t.searchModel.clearInput()}).load(function(){return Te(e)})},this.setItemsList=function(e){o.parentItem(null),e=U(e),o.objects(e)},this.addParentItem=function(){if(!X(t.currentPath())&&t.currentPath()!==b){var e=ae(t.currentPath()),r={id:e,rdo:{id:e,type:"parent",attributes:{readable:!0,writable:!0}},dragHovered:ko.observable(!1)};r.open=function(e,t){i(t)&&o.loadDataList(r.id)},r.itemClass=ko.pureComputed(function(){var e=[];return r.dragHovered()&&e.push(t.ddModel.hoveredCssClass),e.join(" ")}),o.parentItem(r)}},this.setDescriptivePanel=function(t){o.descriptivePanel.content(null),e.each(t,function(e,t){v.manager.renderer.position&&"string"==typeof v.manager.renderer.indexFile&&t.attributes.name.toLowerCase()===v.manager.renderer.indexFile.toLowerCase()&&(o.descriptivePanel.setRenderer(t),Fe(o.descriptivePanel.rdo()).then(function(e){o.descriptivePanel.render(e)}))})},this.findByParam=function(e,t){return ko.utils.arrayFirst(o.objects(),function(i){return i[e]===t})},this.findByFilter=function(e,t){var i=!t,r=[],n=o.objects();if(!n||0===n.length)return i?null:r;for(var s=0,a=n.length;s<a;s++)if(e(n[s])){if(i)return n[s];r.push(n[s])}return i?null:r},this.sortObjects=function(){var e=U(o.objects());o.objects(e)},this.getSelected=function(){var e=o.findByFilter(function(e){return e.selected()},!0)||[];return o.selectedNumber(e.length),e},this.unselectItems=function(t){v.manager.selection.enabled&&v.manager.selection.useCtrlKey&&!0===t||e.each(o.getSelected(),function(e,t){t.selected(!1)})},this.initiateLazyLoad=function(){!0!==v.viewer.image.lazyLoad||o.lazyLoad||(o.lazyLoad=new LazyLoad({container:c[0],callback_load:function(e){r.console("LOADED",e.getAttribute("data-original"))},callback_set:function(e){r.console("SET",e.getAttribute("data-original"))},callback_processed:function(e){r.console("PROCESSED",e+" images left")}}))},this.getPreloader=function(){var e=function(){};return(e.prototype=Object.create(s)).beforeLoad=function(e){t.loadingView(!0)},e.prototype.afterLoad=function(e,i){t.loadingView(!1),o.lazyLoad&&o.lazyLoad.update()},new e},this.objects.subscribe(function(i){var r=0,n=0;e.each(i,function(e,t){r++,"file"===t.rdo.type&&(n+=Number(t.rdo.attributes.size))}),o.objectsNumber(r),o.objectsSize(q(n)),o.lazyLoad&&setTimeout(function(){o.lazyLoad.update()},50),h.contextMenu({selector:".file, .directory",zIndex:100,build:function(e,i){var r=ko.dataFor(e[0]);return r.selected()||(t.itemsModel.unselectItems(!1),r.selected(!0)),{appendTo:".fm-container",items:Re(r.rdo),callback:function(e,i){He(e,i,r.rdo,t.fetchSelectedObjects(r))}}}})})},this.tableViewModel=new function(){var e=function(e){var i=this;this.column=ko.observable(e),this.order=ko.observable(t.itemsModel.listSortOrder()),this.sortClass=ko.pureComputed(function(){var e;return t.itemsModel.listSortField()===i.column()&&(e="sorted sorted-"+this.order()),e},this),this.sort=function(){var e="asc"===i.order(),r=t.itemsModel.listSortField()===i.column();i.order(r?e?"desc":"asc":t.itemsModel.listSortOrder()),t.itemsModel.listSortField(i.column()),t.itemsModel.listSortOrder(i.order()),t.itemsModel.sortObjects()}};this.thName=new e("name"),this.thType=new e("type"),this.thSize=new e("size"),this.thDimensions=new e("dimensions"),this.thModified=new e("modified")},this.previewModel=new function(){var e=this,i=null;this.rdo=ko.observable({}),this.cdo=ko.observable({}),this.viewer={type:ko.observable("default"),isEditable:ko.observable(!1),url:ko.observable(null),pureUrl:ko.observable(null),options:ko.observable({}),content:ko.observable(null),codeMirror:ko.observable(null)},this.renderer=new u,this.editor=new p,this.rdo.subscribe(function(t){e.cdo({isFolder:"folder"===t.type,sizeFormatted:q(t.attributes.size),createdFormatted:G(t.attributes.created),modifiedFormatted:G(t.attributes.modified),extension:"file"===t.type?ne(t.id):null,dimensions:t.attributes.width?t.attributes.width+"x"+t.attributes.height:null})}),this.editor.content.subscribe(function(t){e.editor.isInteractive()&&e.renderer.render(t)}),this.applyObject=function(o){i&&i.destroy(),t.previewFile(!1);var n=o.attributes.name,s={interactive:!1},a={type:"default",url:null,options:{}};e.rdo(o),ce(n)&&(a.type="image",a.url=ke(o,!1,!0)),pe(n)&&!0===v.viewer.audio.enabled&&(a.type="audio",a.url=Me(o,!0)),ue(n)&&!0===v.viewer.video.enabled&&(a.type="video",a.url=Me(o,!0),a.options={width:v.viewer.video.playerWidth,height:v.viewer.video.playerHeight}),he(n)&&!0===v.viewer.opendoc.enabled&&(a.type="opendoc",a.url=r.settings.baseUrl+"/scripts/ViewerJS/index.html#"+Me(o,!0),a.options={width:v.viewer.opendoc.readerWidth,height:v.viewer.opendoc.readerHeight}),me(n)&&!0===v.viewer.google.enabled&&(a.type="google",a.url="https://docs.google.com/viewer?url="+encodeURIComponent(Me(o,!1))+"&embedded=true",a.options={width:v.viewer.google.readerWidth,height:v.viewer.google.readerHeight}),fe(n)&&!0===v.viewer.iframe.enabled&&(a.type="iframe",a.url=Me(o,!0),a.options={width:v.viewer.iframe.readerWidth,height:v.viewer.iframe.readerHeight}),(ve(n)&&!0===v.viewer.codeMirrorRenderer.enabled||be(n)&&!0===v.viewer.markdownRenderer.enabled)&&(a.type="renderer",a.options={is_writable:o.attributes.writable},e.renderer.setRenderer(o),s.interactive=e.renderer.renderer().interactive),e.viewer.type(a.type),e.viewer.url(a.url),e.viewer.options(a.options),e.viewer.pureUrl(xe(o)),e.viewer.isEditable(de(n)&&!0===v.editor.enabled),e.editor.isInteractive(s.interactive),"renderer"===a.type||e.viewer.isEditable()?Fe(o).then(function(i){e.viewer.content(i),t.previewFile(!0)}):t.previewFile(!0)},this.afterRender=function(){e.renderer.render(e.viewer.content());var t=f.find(".btn-copy-url")[0];(i=new Clipboard(t)).on("success",function(e){r.success(A("copied"))})},this.initiateEditor=function(t){var i=f.find(".fm-cm-editor-content")[0];e.editor.createInstance(e.cdo().extension,i,{readOnly:!1,styleActiveLine:!0})},this.bindToolbar=function(t){Y(e.rdo(),t)&&He(t,{},e.rdo())},this.previewIconClass=ko.pureComputed(function(){var t=[],i=["ico"];return"default"!==e.viewer.type()&&e.viewer.url()||(t.push("grid-icon"),!0===this.cdo().isFolder?(t.push("ico_folder"),i.push("folder"),this.rdo().attributes.readable||i.push("lock")):(t.push("ico_file"),this.rdo().attributes.readable?i.push("ext",this.cdo().extension):i.push("file","lock")),t.push(i.join("_"))),t.join(" ")},this),this.closePreview=function(){t.previewFile(!1)},this.editFile=function(){var t=e.viewer.content();e.renderer.render(t),e.editor.render(t)},this.saveFile=function(){Pe(e.rdo())},this.closeEditor=function(){e.editor.enabled(!1),e.renderer.render(e.viewer.content())},this.buttonVisibility=function(t){switch(t){case"select":return Y(e.rdo(),t)&&Le();case"move":case"rename":case"delete":case"download":return Y(e.rdo(),t)}}},this.headerModel=new function(){this.closeButton=ko.observable(!1),this.langSwitcher=e.isArray(v.language.available)&&v.language.available.length>0,this.closeButtonOnClick=function(){r.console("CLOSE button is clicked")},this.navHome=function(){t.previewFile(!1),t.itemsModel.loadDataList(b)},this.navLevelUp=function(){var e=t.previewFile()?se(t.previewModel.rdo().id):ae(t.currentPath());t.previewFile()&&t.previewFile(!1),e!==t.currentPath()&&t.itemsModel.loadDataList(e)},this.navRefresh=function(){t.previewFile()?(t.previewFile(!1),t.previewFile(!0)):t.itemsModel.loadDataList(t.currentPath())},this.displayGrid=function(){t.viewMode("grid"),t.previewFile(!1),t.itemsModel.lazyLoad&&t.itemsModel.lazyLoad.update()},this.displayList=function(){t.viewMode("list"),t.previewFile(!1)},this.switchLang=function(t){var i=t.target.value,r=C.getLang();if(i&&i.toLowerCase()!==r.toLowerCase()){var o,n=window.location.toString(),s=new RegExp("(langCode=)"+r);o=s.test(n)?n.replace(s,"$1"+i):n+(e.isEmptyObject(L.param())?"?":"#")+"langCode="+i,window.location.href=o}},this.createFolder=function(){if(!Q("createFolder"))return r.error(A("NOT_ALLOWED")),!1;r.prompt({message:A("prompt_foldername"),value:A("default_foldername"),okBtn:{label:A("create_folder"),autoClose:!1,click:function(e,t){var i=t.getInputValue();i?we("GET",{mode:"addfolder",path:k.currentPath(),name:i}).done(function(e){e.data&&(k.addElements(e.data,k.currentPath()),t.closeDialog(),v.options.showConfirmation&&r.success(A("successful_added_folder")))}).fail($):r.error(A("no_foldername"))}},cancelBtn:{label:A("cancel")}})}},this.summaryModel=new function(){this.files=ko.observable(null),this.folders=ko.observable(null),this.size=ko.observable(null),this.enabled=ko.observable(!1),this.doSummarize=function(){Ae()}},this.filterModel=new function(){var i=this;this.name=ko.observable(null),this.setName=function(t){t&&v.filter&&e.isArray(v.filter[t])&&i.name(t)},this.getExtensions=function(){return i.name()?v.filter[i.name()]:null},this.filterItem=function(t){var r=i.getExtensions(),o=!t.cdo.hiddenBySearch;if(t.cdo.hiddenByType=!1,"file"===t.rdo.type&&e.isArray(r)){var n=ne(t.id),s=-1!==r.indexOf(n);o=o&&s,t.cdo.hiddenByType=!s}t.visible(o)},this.filter=function(r){i.setName(r),e.each(t.itemsModel.objects(),function(e,t){i.filterItem(t)}),t.treeModel.mapNodes(function(e){i.filterItem(e)}),t.itemsModel.lazyLoad&&t.itemsModel.lazyLoad.update()},this.reset=function(){i.name(null),i.filter(null)}},this.searchModel=new function(){var i=this,o="",n=!!v.search.typingDelay;this.value=ko.observable(""),this.value.subscribe(function(e){o=e},null,"beforeChange"),this.inputKeyUp=function(e,t){var r=t.which||t.keyCode;if(n){if([16,17,18,27,37,38,39,40].indexOf(r)>-1)return;i.value(t.target.value)}(n||13===r)&&s()},this.seekItems=function(e,t){s()},this.reset=function(e,t){l()},this.clearInput=function(){i.value(""),o=i.value(),S.removeTimer("search")};function s(){n?S.push("search",function(){a()},v.search.typingDelay):a()}function a(){var n=i.value(),s=v.search.caseSensitive?n:n.toLowerCase();if(""!==n)if(v.search.recursive){var a=t.currentPath();new d(a).setPreloader(t.itemsModel.getPreloader()).setDataHandler(function(i,r){var o=[];v.search.caseSensitive?e.each(i,function(e,t){0===t.attributes.name.indexOf(s)&&o.push(t)}):o=i;var n=t.itemsModel.createItems(o);t.itemsModel.setItemsList(n)}).load(function(){return De(a,n)})}else e.each(t.itemsModel.objects(),function(e,t){var i=t.rdo.attributes.name;v.search.caseSensitive||(i=i.toLowerCase());var r=0===i.indexOf(s),o=!t.cdo.hiddenByType;o=o&&r,t.cdo.hiddenBySearch=!r,t.visible(o)});else n!==o?l():r.warning(A("search_string_empty"))}function l(){i.clearInput(),v.search.recursive?t.itemsModel.loadDataList(t.currentPath()):e.each(t.itemsModel.objects(),function(e,t){t.cdo.hiddenBySearch=!1,t.visible(!t.cdo.hiddenByType)})}},this.clipboardModel=new function(){var e=null,i=[],o=this,n=Q("copy")&&Q("move");this.itemsNum=ko.observable(0),this.enabled=ko.observable(t.config().clipboard.enabled&&n),this.copy=function(){o.hasCapability("copy")&&(e="copy",i=t.fetchSelectedItems(),o.itemsNum(i.length))},this.cut=function(){o.hasCapability("cut")&&(e="cut",i=t.fetchSelectedItems(),o.itemsNum(i.length))},this.paste=function(){var n=t.currentPath();o.hasCapability("paste")&&!o.isEmpty()&&(null!==e&&0!==i.length?Se(i,function(t,i){return"cut"===e?Ie(i,n):"copy"===e?Ne(i,n):void 0},s):r.warning(A("clipboard_empty")))},this.clear=function(){o.hasCapability("clear")&&!o.isEmpty()&&(s(),r.success(A("clipboard_cleared")))},this.isEmpty=function(){return 0===i.length},this.hasCapability=function(e){if(!o.enabled)return!1;switch(e){case"copy":return Q("copy");case"cut":return Q("move");default:return!0}};function s(){i=[],e=null,o.itemsNum(0)}},this.breadcrumbsModel=new function(){var e=this;this.items=ko.observableArray([]),this.clean=function(){e.items([]),e.add(b,"")},this.add=function(t,r){e.items.push(new i(t,r))},this.splitPath=function(t){var i=b,r=t.replace(new RegExp("^"+b),"").split("/");for(e.clean();r.length>0;){var o=r.shift();o&&(i+=o+"/",e.add(i,o))}},this.splitCurrent=function(){e.splitPath(t.currentPath())},this.getLabel=ko.pureComputed(function(){return(t.searchModel.value()?A("search_results"):A("current_folder"))+": "},this);var i=function(e,i){var r=this;this.path=e,this.label=i,this.isRoot=e===b,this.active=e===t.currentPath(),this.itemClass=function(){var e=["nav-item"];return r.isRoot&&e.push("root"),r.active&&e.push("active"),e.join(" ")},this.goto=function(e,i){e.active||t.itemsModel.loadDataList(e.path)}}},this.ddModel=new function(){var i=this,r="drop-restricted",s=e("#drag-helper-template");this.items=[],this.hoveredItem=null,this.dragHelper=null,this.isScrolling=!1,this.isScrolled=!1,this.hoveredCssClass="drop-hover",this.makeDraggable=function(r,a){"file"!==r.rdo.type&&"folder"!==r.rdo.type||e(a).draggable({distance:3,cursor:"pointer",cursorAt:{left:Math.floor(s.width()/2),bottom:15},scroll:!1,appendTo:n,containment:o,refreshPositions:!1,helper:function(){var e,o;return o=t.fetchSelectedItems(r.constructor.name).length>1?"ico_multiple":"folder"===r.rdo.type?"ico_folder":"ico_file ico_ext_"+ne(r.rdo.id),(e=s.children(".drag-helper").clone()).find(".clip").addClass(o),i.dragHelper=e,e},start:function(e,o){i.items=t.fetchSelectedItems(r.constructor.name)},drag:function(t,r){e(this).draggable("option","refreshPositions",i.isScrolling||i.isScrolled),i.isScrolled=!1},stop:function(e,t){i.items=[],i.dragHelper=null}})},this.makeDroppable=function(t,r){"folder"!==t.rdo.type&&"parent"!==t.rdo.type||e(r).droppable({tolerance:"pointer",enableExtendedEvents:t instanceof l,accept:function(e){var t=ko.dataFor(e[0]),i=t?t.rdo.type:null;return"file"===i||"folder"===i},over:function(e,i){setTimeout(function(){d(null),c(i.helper,!1),a(t)||c(i.helper,!0),d(t)},0)},out:function(e,t){d(null),c(t.helper,!1)},drop:function(e,r){if(d(null),!a(t))return!1;Se(i.items,function(e,i){return Ie(i.rdo,t.id)})}})};function a(t){var r=e.grep(i.items,function(e,i){if("folder"===t.rdo.type||"parent"===t.rdo.type){if(ie(t.rdo.id,e.rdo.id))return!0;if(t.rdo.id===le(e.rdo.id))return!0}return e.id===t.id});return t.rdo.attributes.writable&&0===r.length}function d(e){null!==i.hoveredItem&&i.hoveredItem.dragHovered(!1),i.hoveredItem=e,e&&e.dragHovered(!0)}function c(e,t){t?e.addClass(r):e.removeClass(r)}},this.selectionModel=new function(){this.unselect=!1}},A=function(e){return C.translate(e)},U=function(e){var t={natural:!0,order:"asc"===("list"===k.viewMode()?k.itemsModel.listSortOrder():M)?1:-1,cases:!1};e.sort(function(e,o){var n,s=i(e),a=i(o);return n=s===a?0:void 0===s||void 0===a?0:t.natural&&(isNaN(s)||isNaN(a))?function(e,t){for(var i=r(e.toString()),o=r(t.toString()),n=0;i[n]&&o[n];n++)if(i[n]!==o[n]){var s=Number(i[n]),a=Number(o[n]);return s==i[n]&&a==o[n]?s-a:i[n]>o[n]?1:-1}return i.length-o.length}(s,a):s<a?-1:s>a?1:0,n*=t.order});function i(e){var i,r=y;switch("list"===k.viewMode()&&(r=k.itemsModel.listSortField()),r){case"type":i=e.cdo.extension||"";break;case"size":i=e.rdo.attributes.size;break;case"modified":i=e.rdo.attributes.modified;break;case"dimensions":i=e.cdo.dimensions||"";break;default:i=e.rdo.attributes.name}return"string"==typeof i&&(t.cases||(i=i.toLowerCase()),i=i.replace(/\s+/g," ")),i}function r(e){for(var t,i,r=[],o=0,n=-1,s=0;t=(i=e.charAt(o++)).charCodeAt(0);){var a=46==t||t>=48&&t<=57;a!==s&&(r[++n]="",s=a),r[n]+=i}return r}for(var o=[],n=e.length;n--;)"folder"===e[n].rdo.type&&(o.push(e[n]),e.splice(n,1));"top"!==v.options.folderPosition&&o.reverse();for(var s=0,a=o.length;s<a;s++)"top"===v.options.folderPosition?e.unshift(o[s]):e.push(o[s]);return e},B=function(t){return e.ajax({type:"HEAD",url:t})},R=function(t){var i=null;return i="user"===(t=void 0===t?"user":t)?L.param("config")?r.settings.baseUrl+"/config/"+L.param("config"):r.settings.baseUrl+"/config/filemanager.config.json":r.settings.baseUrl+"/config/filemanager.config.default.json",e.ajax({type:"GET",url:i,dataType:"json",cache:!1,error:function(e){r.error("Given config file ("+i+") does not exist!")}})},H=function(e){for(var t=0,i=e.length;t<i;t++)"string"==typeof e[t]&&(e[t]=r.settings.baseUrl+e[t]);toast.apply(this,e)},W=function(t,i){return e.ajax({type:"GET",url:r.settings.baseUrl+"/scripts/templates/"+t+".html",error:$})},q=function(e,t){if(!e)return"";t=t||!1;for(var i=parseFloat(e),r=parseFloat(t?1e3:1024),o=0,n=[A("unit_bytes"),A("unit_kb"),A("unit_mb"),A("unit_gb")];;){if(i<r)return(i=Math.round(100*i)/100)+" "+n[o];i/=r,o+=1}},G=function(e){if(!e||e<=0)return"";var t=new Date;return t.setTime(1e3*e),x.formatDate(t,v.formatter.datetime)},K=function(t){var i;return C.getLang()&&A(t.title)?(i=A(t.title),e.each(t.meta.arguments,function(e,t){i=i.replace("%s",t)})):i=t.title,i},V=function(t){r.console("ERROR JSON",t),e.each(t,function(e,t){r.error(K(t)),t.meta.redirect&&(window.location.href=t.meta.redirect)})},$=function(t){var i;if(e.isPlainObject(t)&&t.responseText){var o="application/json"===t.getResponseHeader("content-type");!t.responseJSON&&o&&(t.responseJSON=e.parseJSON(t.responseText)),e.isPlainObject(t.responseJSON)&&t.responseJSON.errors?V(t.responseJSON.errors):i=A("ERROR_SERVER")+" "+t.responseText}else i=t;i&&(r.console("ERROR TEXT",i),r.error(i))};function Q(e){return w.indexOf(e)>-1}function Y(t,i){if(!Q(i))return!1;if("select"===i&&"folder"===t.type)return!1;if("extract"===i){var r=ne(t.attributes.name);return"file"===t.type&&"zip"===r}return"download"===i&&"folder"===t.type?!0===v.options.allowFolderDownload:void 0===t.attributes.capabilities||e.inArray(i,t.attributes.capabilities)>-1}(J=jQuery).extend({inArrayInsensitive:function(e,t,i){if("string"!=typeof e)return J.inArray.apply(this,arguments);if(t){var r=t.length;for(i=i?i<0?Math.max(0,r+i):i:0,e=e.toLowerCase();i<r;i++)if(i in t&&t[i].toLowerCase()==e)return i}return-1}});var J,X=function(e){return"/"!==e.charAt(e.length-1)},Z=function(e,t){var i=new RegExp("^"+t+"+|"+t+"+$","g");return e.replace(i,"")},ee=function(e,t){var i=new RegExp("^"+t+"+","g");return e.replace(i,"")},te=function(e,t){var i=new RegExp(t+"+$","g");return e.replace(i,"")},ie=function(e,t,i){return i=i||0,e.substr(i,t.length)===t},re=function(t){var i=[];return e.each(t.split("/"),function(e,t){i.push(encodeURIComponent(t))}),i.join("/")},oe=function(e){return e.replace(/\\/g,"/").replace(/\/+/g,"/")},ne=function(e){return 1===e.split(".").length?"":e.split(".").pop().toLowerCase()},se=function(e){return e.lastIndexOf("/")!==e.length-1?e.substr(0,e.lastIndexOf("/")+1):e},ae=function(e){return e.split("/").reverse().slice(2).reverse().join("/")+"/"},le=function(e){return e.substring(0,e.slice(0,-1).lastIndexOf("/"))+"/"},de=function(t){return-1!==e.inArray(ne(t),v.editor.extensions)},ce=function(t){return-1!==e.inArray(ne(t),v.viewer.image.extensions)},ue=function(t){return-1!==e.inArray(ne(t),v.viewer.video.extensions)},pe=function(t){return-1!==e.inArray(ne(t),v.viewer.audio.extensions)},fe=function(t){return-1!==e.inArray(ne(t),v.viewer.iframe.extensions)},he=function(t){return-1!==e.inArray(ne(t),v.viewer.opendoc.extensions)},me=function(t){return-1!==e.inArray(ne(t),v.viewer.google.extensions)},ve=function(t){return-1!==e.inArray(ne(t),v.viewer.codeMirrorRenderer.extensions)},be=function(t){return-1!==e.inArray(ne(t),v.viewer.markdownRenderer.extensions)},ge=function(t,i){var o,n=v.api.requestParams;if(t=t.toUpperCase(),e.isPlainObject(n)&&(o=n[t],e.isPlainObject(o)&&!e.isEmptyObject(o))){var s=e.extend({},n.MIXED||{},o);"POST"===t&&e.isArray(i)?e.each(s,function(e,t){i.push({name:e,value:t})}):i=e.extend({},i,s)}return i=r.settings.callbacks.beforeSetRequestParams(t,i)},we=function(t,i,o){return o=void 0===o?"json":o,!1===r.settings.callbacks.beforeSendRequest(t,i)?e.Deferred().reject(A("NOT_ALLOWED")):e.ajax({type:t,cache:!1,url:ye(),dataType:o,data:ge(t,i)})},ye=function(t){var i={time:(new Date).getTime()},r=e.extend({},t||{},i);return g+"?"+e.param(r)},Me=function(e,t){var i,o=e.attributes.path;if(v.viewer.absolutePath&&o)t&&(o=re(o)),i=Ce(o,!1);else{var n=ge("GET",{mode:"readfile",path:e.id});i=ye(n)}return i=r.settings.callbacks.beforeCreatePreviewUrl(e,i)},ke=function(e,t,i){var o;if(ce(e.id)&&e.attributes.readable&&(t&&v.viewer.image.showThumbs||!t&&!0===v.viewer.image.enabled)){if(v.viewer.absolutePath&&!t&&e.attributes.path)o=Ce(re(e.attributes.path),i);else{var n={path:e.id};"svg"===ne(e.id)?n.mode="readfile":(n.mode="getimage",t&&(n.thumbnail="true")),n=ge("GET",n),o=ye(n)}o=r.settings.callbacks.beforeCreateImageUrl(e,o)}return o},Ce=function(e,t){var i="string"==typeof v.viewer.previewUrl?v.viewer.previewUrl:location.origin;return i=Z(i,"/")+e,t&&(i+="?time="+(new Date).getTime()),i},xe=function(e){function t(e){return v.clipboard.encodeCopyUrl?re(e):e}if(v.viewer.absolutePath&&e.attributes.path){var i=t(e.attributes.path);return Ce(i,!1)}i=t(e.id);var r="folder"===e.type?"readfolder":"readfile";return g+"?path="+i+"&mode="+r},Se=function(t,i,o){var n,s=new function(){this.total=0,this.succeed=0,this.failure=0,this.processed=0,this.getProgress=function(){return Math.round(this.processed/this.total*100)},this.getProgressSucceed=function(){return Math.round(this.succeed/this.total*100)},this.getProgressFailure=function(){return Math.round(this.failure/this.total*100)},this.getMessage=function(){return A("successful_processed").replace("%s",this.succeed).replace("%s",this.total)},this.succeeded=function(){this.succeed++,this.processed++},this.failed=function(){this.failure++,this.processed++},this.isProcessed=function(){return this.processed===this.total}},a=e.Deferred().resolve();s.total=t.length,s.total>1&&(n=r.write(s.getMessage(),{delay:0,logMessageTemplate:function(e){s.getProgress();var t=s.isProcessed()?"striped":"striped animated";return"<div>"+e+'</div><div class="progress"><div class="progress-counter">'+s.getProgress()+'%</div><div class="progress-bar '+t+'"><div class="progress-segment progress-succeed" style="width: '+s.getProgressSucceed()+'%"></div><div class="progress-segment progress-failure" style="width: '+s.getProgressFailure()+'%"></div></div></div>'}})).stick(!0),e.each(t,function(e,t){a=a.then(function(){return i(e,t)}).then(function(e){e&&e.data?s.succeeded():s.failed(),n&&n.setMessage(s.getMessage())})}),a.then(function(){n&&s.isProcessed()&&(n.stick(!1),setTimeout(function(){n.remove()},6e3))}),a.then(function(){"function"==typeof o&&o()})},je=function(){if(document.selection&&document.selection.empty)document.selection.empty();else if(window.getSelection){window.getSelection().removeAllRanges()}};function Le(){return window.opener||window.parent&&window.self!==window.parent||window.tinyMCEPopup||L.param("field_name")||L.param("CKEditor")||L.param("ImperaviElementId")}var _e=function(e){var t=null,i=Me(e,!0);if(i=r.settings.callbacks.beforeSelectItem(e,i),window.tinyMCEPopup){var o=tinyMCEPopup.getWindowArg("window");return o.document.getElementById(tinyMCEPopup.getWindowArg("input")).value=i,void 0!==o.ImageDialog&&(o.ImageDialog.getImageData&&o.ImageDialog.getImageData(),o.ImageDialog.showPreviewImage&&o.ImageDialog.showPreviewImage(i)),void tinyMCEPopup.close()}if(L.param("field_name")&&(parent.document.getElementById(L.param("field_name")).value=i,void 0!==parent.tinyMCE&&parent.tinyMCE.activeEditor.windowManager.close(),void 0!==parent.$.fn.colorbox&&parent.$.fn.colorbox.close()),L.param("ImperaviElementId"))if(window.opener);else{var n=L.param("ImperaviElementId"),s=parent.$("#"+n).redactor("core.getObject");s&&(s.modal.close(),s.buffer.set(),ce(e.attributes.name)?s.insert.html('<img src="'+i+'">'):s.insert.html('<a href="'+i+'">'+e.attributes.name+"</a>"))}if(L.param("CKEditor")&&(window.opener?window.opener.CKEDITOR.tools.callFunction(L.param("CKEditorFuncNum"),i):(parent.CKEDITOR.tools.callFunction(L.param("CKEditorFuncNum"),i),parent.CKEDITOR.tools.callFunction(L.param("CKEditorCleanUpFuncNum")))),window.opener&&"function"==typeof window.opener.SetUrl)if(e.attributes.width){var a=i,l=e.attributes.width,d=e.attributes.height;window.opener.SetUrl(a,l,d)}else window.opener.SetUrl(i);window.opener&&(t=window.opener),window.parent&&window.self!==window.parent&&(t=window.parent),t&&t.postMessage({source:"richfilemanager",preview_url:i},"*"),r.settings.callbacks.afterSelectItem(e,i,t)},Ee=function(t){r.prompt({message:A("new_filename"),value:v.options.allowChangeExtensions?t.attributes.name:(i=t.attributes.name,-1!==i.lastIndexOf(".")?i.substring(0,i.lastIndexOf(".")):i),okBtn:{label:A("action_rename"),autoClose:!1,click:function(i,o){var n=t.id,s=o.getInputValue();if(s){if(!v.options.allowChangeExtensions){var a=ne(t.attributes.name);a.length>0&&(s=s+"."+a)}if(X(n)&&!function(t){var i=ne(t);if(v.security.extensions.ignoreCase){if("ALLOW_LIST"===v.security.extensions.policy&&-1!==e.inArrayInsensitive(i,v.security.extensions.restrictions))return!0;if("DISALLOW_LIST"===v.security.extensions.policy&&-1===e.inArrayInsensitive(i,v.security.extensions.restrictions))return!0}else{if("ALLOW_LIST"===v.security.extensions.policy&&-1!==e.inArray(i,v.security.extensions.restrictions))return!0;if("DISALLOW_LIST"===v.security.extensions.policy&&-1===e.inArray(i,v.security.extensions.restrictions))return!0}return!1}(s)){var l="<p>"+A("INVALID_FILE_TYPE")+"</p>";return"ALLOW_LIST"===v.security.extensions.policy&&(l+="<p>"+A("ALLOWED_FILE_TYPE").replace("%s",v.security.extensions.restrictions.join(", "))+".</p>"),"DISALLOW_LIST"===v.security.extensions.policy&&(l+="<p>"+A("DISALLOWED_FILE_TYPE").replace("%s",v.security.extensions.restrictions.join(", "))+".</p>"),void r.error(l)}we("GET",{mode:"rename",old:n,new:s}).done(function(e){if(e.data){var t=e.data,i=k.treeModel.findByParam("id",n);if(i&&("folder"===i.rdo.type&&(i.nodeTitle(t.attributes.name),k.treeModel.actualizeNodeObject(i,n,t.id)),"file"===i.rdo.type)){var s=i.parentNode(),a=k.treeModel.createNode(t);i.remove(),s&&k.treeModel.appendNodes(s,a)}var l=k.itemsModel.parentItem();if(l&&l.id===n)k.itemsModel.parentItem().id=t.id;else{var d=k.itemsModel.findByParam("id",n);if(d){d.remove();var c=k.itemsModel.createItem(t);k.itemsModel.appendItems(c)}}k.currentPath()===n&&k.itemsModel.loadDataList(t.id),k.previewFile()&&k.previewModel.rdo().id===n&&k.previewModel.applyObject(t),o.closeDialog(),v.options.showConfirmation&&r.success(A("successful_rename"))}}).fail($)}else r.error(A("new_filename"))}},cancelBtn:{label:A("cancel")}});var i},Ne=function(e,t){return we("GET",{mode:"copy",source:e.id,target:t}).done(function(e){if(e.data){var i=e.data;k.addElements(i,t),alertify.clearDialogs(),v.options.showConfirmation&&r.success(A("successful_copied"))}}).fail($)},Ie=function(e,t){return we("GET",{mode:"move",old:e.id,new:t}).done(function(i){if(i.data){var o=i.data;k.removeElement(e),k.addElements(o,t),k.currentPath()===e.id&&k.itemsModel.loadDataList(o.id),k.previewFile()&&k.previewModel.rdo().id===e.id&&k.previewFile(!1),alertify.clearDialogs(),v.options.showConfirmation&&r.success(A("successful_moved"))}}).fail($)},Oe=function(e){return we("GET",{mode:"delete",path:e}).done(function(e){if(e.data){var t=e.data;if(k.removeElement(t),"folder"===t.type&&ie(k.currentPath(),t.id)){var i=ae(t.id);k.itemsModel.loadDataList(i)}k.previewFile()&&k.previewModel.rdo().id===t.id&&k.previewFile(!1),v.options.showConfirmation&&r.success(A("successful_delete"))}}).fail($)},Pe=function(t){var i=e("#fm-js-editor-form").serializeArray();we("POST",i).done(function(e){if(e.data){var t=e.data,i=k.previewModel,o=i.editor.content();i.rdo(t),i.viewer.content(o),i.closeEditor();var n=k.itemsModel.createItem(t),s=k.itemsModel.findByParam("id",t.id);k.itemsModel.objects.replace(s,n),r.success(A("successful_edit"))}}).fail($)},Fe=function(e){return we("GET",{mode:"readfile",path:e.id},"text").fail($)},Te=function(e){return we("GET",{mode:"readfolder",path:e}).fail($)},De=function(e,t){return we("GET",{mode:"seekfolder",path:e,string:t}).fail($)},ze=function(e){return we("GET",{mode:"getinfo",path:e}).fail($)},Ae=function(){return we("GET",{mode:"summarize"}).done(function(t){if(t.data){var i=t.data.attributes,o=q(i.size,!0);if(i.sizeLimit>0){var n=q(i.sizeLimit,!0),s=100*i.size/i.sizeLimit;o+=" ("+Math.round(100*s)/100+"%) "+A("of")+" "+n}k.summaryModel.files(i.files),k.summaryModel.folders(i.folders),k.summaryModel.size(o),k.summaryModel.enabled(!0);var a=e("#summary-popup").clone().show();k.summaryModel.enabled(!1),r.alert(a[0].outerHTML)}}).fail($)},Ue=function(e,t){we("POST",{mode:"extract",source:e.id,target:t}).done(function(e){e.data&&(k.addElements(e.data,t),alertify.clearDialogs(),v.options.showConfirmation&&r.success(A("successful_extracted")))}).fail($)};function Be(e){if(!e.attributes.readable)return r.error(A("NOT_ALLOWED_SYSTEM")),!1;"file"===e.type&&k.previewModel.applyObject(e),"folder"!==e.type&&"parent"!==e.type||(k.previewFile(!1),k.itemsModel.loadDataList(e.id))}function Re(e){var t=!k.clipboardModel.enabled(),i={select:{name:A("action_select"),className:"select"},download:{name:A("action_download"),className:"download"},rename:{name:A("action_rename"),className:"rename"},move:{name:A("action_move"),className:"move"},separator1:"-----",copy:{name:A("clipboard_copy"),className:"copy"},cut:{name:A("clipboard_cut"),className:"cut"},delete:{name:A("action_delete"),className:"delete"},extract:{name:A("action_extract"),className:"extract"},copyUrl:{name:A("copy_to_clipboard"),className:"copy-url"}};return Y(e,"download")||delete i.download,Y(e,"select")&&Le()||delete i.select,Y(e,"rename")&&!0!==v.options.browseOnly||delete i.rename,Y(e,"delete")&&!0!==v.options.browseOnly||delete i.delete,Y(e,"extract")&&!0!==v.options.browseOnly||delete i.extract,Y(e,"copy")&&!0!==v.options.browseOnly&&!t||delete i.copy,Y(e,"move")&&!0!==v.options.browseOnly&&!t||(delete i.cut,delete i.move),i}var He=function(t,i,o,n){var s=n||[o];switch(t){case"select":_e(o);break;case"download":e.each(s,function(t,i){!function(t){var i={mode:"download",path:t.id};e.fileDownload(ye(i),{failCallback:function(t,i,r){var o=e(t).text(),n=e.parseJSON(o);e.isPlainObject(n)&&n.errors&&V(n.errors)}})}(i)});break;case"rename":Ee(o);break;case"move":!function(e,t){var i=e.length,o=i>1?A("prompt_move_multiple").replace("%s",i):A("prompt_move");r.prompt({message:o,value:k.currentPath(),okBtn:{label:A("action_move"),autoClose:!1,click:function(e,i){var o=i.getInputValue();o?(o=te(o,"/")+"/",t(o)):r.error(A("prompt_foldername"))}},cancelBtn:{label:A("cancel")},template:{dialogInput:'<input data-alertify-input type="text" value="" /><div class="prompt-info">'+A("help_move")+"</div>"}})}(s,function(e){Se(s,function(t,i){return Ie(i,e)})});break;case"delete":!function(e,t){var i=e.length,o=i>1?A("confirm_delete_multiple").replace("%s",i):A("confirm_delete");r.confirm({message:o,okBtn:{label:A("yes"),click:function(e,i){t()}},cancelBtn:{label:A("no")}})}(s,function(){Se(s,function(e,t){return Oe(t.id)})});break;case"extract":l=o,r.prompt({message:A("prompt_extract"),value:k.currentPath(),okBtn:{label:A("action_extract"),autoClose:!1,click:function(e,t){var i=t.getInputValue();i?(i=te(i,"/")+"/",Ue(l,i)):r.error(A("prompt_foldername"))}},cancelBtn:{label:A("cancel")}});break;case"copy":k.clipboardModel.copy(s);break;case"cut":k.clipboardModel.cut(s);break;case"copyUrl":var a=new Clipboard(i.$selected[0],{text:function(e){return xe(o)}});a.on("success",function(e){r.success(A("copied")),a.destroy()})}var l},We=function(){if(v.options.browseOnly)return!1;v.upload.multiple?m.unbind().click(function(){if(!Q("upload"))return r.error(A("NOT_ALLOWED")),!1;var t=null,i=k.currentPath(),o=tmpl("tmpl-fileupload-container",{folder:A("current_folder")+i,info:A("upload_files_number_limit").replace("%s",v.upload.maxNumberOfFiles)+" "+A("upload_file_size_limit").replace("%s",q(v.upload.fileSizeLimit,!0)),lang:C.getTranslations()});"ALLOW_LIST"===v.security.extensions.policy&&(t=new RegExp("(\\.|\\/)("+v.security.extensions.restrictions.join("|")+")$","i")),r.dialog({message:o,width:"auto",buttons:[{type:"ok",label:A("action_upload"),autoClose:!1,click:function(e,t){s.children(".upload-item").length>0?s.find(".button-start").trigger("click"):r.error(A("upload_choose_file"))}},{label:A("action_select"),closeOnClick:!1,click:function(t,i){e("#fileupload",n).trigger("click")}},{type:"cancel",label:A("close")}]});var n=e(".fm-fileupload-container"),s=e(".dropzone",n),a=e(".dropzone-wrapper",n),l=e("#total-progress",n).children();v.customScrollbar.enabled&&a.mCustomScrollbar({theme:v.customScrollbar.theme,scrollButtons:{enable:v.customScrollbar.button},advanced:{autoExpandHorizontalScroll:!0,updateOnContentResize:!0},callbacks:{onOverflowY:function(){a.find(".mCSB_container").css({"margin-right":a.find(".mCSB_scrollTools").width()})},onOverflowYNone:function(){a.find(".mCSB_container").css({"margin-right":"auto"})}},axis:"y"}),a.on("click",function(t){(t.target===this||e(t.target).parent()[0]===this||t.target===s[0]||e(t.target).parent().hasClass("default-message"))&&e("#fileupload",n).trigger("click")}),s.on("click",".button-start",function(t){var i=e(this);i.parent().parent().data().submit(),i.remove()}),s.on("click",".button-abort",function(t){var i=e(this).parent().parent().data(),r=i.files[0].context;i.abort(),r.find(".error-message").text(A("upload_aborted")),r.addClass("aborted")}),s.on("click",".button-resume",function(t){var r=e(this).parent().parent().data(),o=r.files[0];function n(i){e.blueimp.fileupload.prototype.options.add.call(e("#fileupload")[0],t,i),i.submit()}if(o.chunkUploaded){var s=i+o.serverName;ze(s).then(function(e){e.data&&(r.uploadedBytes=Number(e.data.attributes.size),r.uploadedBytes||(o.chunkUploaded=void 0),n(r))})}else n(r)}),s.on("click",".button-remove",function(t){var r=e(this),o=r.parent().parent().data().files[0];o.chunkUploaded&&Oe(i+o.serverName),r.closest(".upload-item").remove(),d()}),s.on("click",".button-info",function(t){var i=e(this).closest(".upload-item");if(i.hasClass("error")){var o=i.find(".error-message");r.error(o.text())}});var d=function(){s.children(".upload-item").length>0?s.addClass("started"):s.removeClass("started")},c=k.filterModel.getExtensions();c&&e("#fileupload").attr("accept",c.map(function(e){return"."+e}).join()),e("#fileupload",n).fileupload({autoUpload:!1,sequentialUploads:!0,dataType:"json",dropZone:s,maxChunkSize:v.upload.chunkSize,url:ye(),paramName:"files",singleFileUploads:!0,formData:ge("POST",{mode:"upload",path:i}),maxNumberOfFiles:v.upload.maxNumberOfFiles,acceptFileTypes:t,maxFileSize:v.upload.fileSizeLimit,messages:{maxNumberOfFiles:A("upload_files_number_limit").replace("%s",v.upload.maxNumberOfFiles),acceptFileTypes:A("upload_file_type_invalid"),maxFileSize:A("upload_file_too_big")+" "+A("upload_file_size_limit").replace("%s",q(v.upload.fileSizeLimit,!0))},previewMaxHeight:120,previewMaxWidth:120,previewCrop:!0}).on("fileuploadadd",function(t,i){var o=s.children(".upload-item");e.each(i.files,function(t,n){if(o.length>=v.upload.maxNumberOfFiles)return r.error(A("upload_files_number_limit").replace("%s",v.upload.maxNumberOfFiles),{logClass:"fileuploadadd",unique:!0}),!1;n.formattedSize=q(n.size);var a=e(tmpl("tmpl-upload-item",{file:n,lang:C.getTranslations(),imagesPath:r.settings.baseUrl+"/scripts/jQuery-File-Upload/img"}));n.context=a,a.find(".buttons").data(i),a.appendTo(s)}),d()}).on("fileuploadsend",function(t,i){if(!1===r.settings.callbacks.beforeSendRequest(i.type,i.formData))return e.each(i.files,function(e,t){var i=t.context;i.find(".error-message").text(A("NOT_ALLOWED")),i.removeClass("added process").addClass("error")}),!1;e.each(i.files,function(e,t){var r=t.context;r.removeClass("added aborted error").addClass("process"),t.chunkUploaded&&i.total===i.uploadedBytes&&r.remove()})}).on("fileuploadfail",function(t,i){e.each(i.files,function(e,t){t.error=A("upload_failed");t.context.removeClass("added process").addClass("error")})}).on("fileuploaddone",function(t,i){var r=i.result;e.each(i.files,function(e,t){var i=t.context;r&&r.errors?(i.removeClass("added process").addClass("error"),i.find(".error-message").text(K(r.errors[0])),i.find(".button-start").remove()):i.remove()})}).on("fileuploadalways",function(t,i){var o=i.result;e.each(i.files,function(e,t){if(o&&o.data&&o.data[e]){var i=o.data[e];k.removeElement(i),k.addElements(i,k.currentPath())}});var n=s.children(".upload-item");0===n.filter(".added").length&&0===n.filter(".process").length&&(0===n.length&&(alertify.clearDialogs(),v.options.showConfirmation&&r.success(A("upload_successful_files"))),n.filter(".error").length&&r.error(A("upload_partially")+"<br>"+A("upload_failed_details"))),d()}).on("fileuploadchunkdone",function(t,i){var r=i.result;e.each(i.files,function(e,t){if(r.data&&r.data[e]){var i=r.data[e];k.removeElement(i),k.addElements(i,k.currentPath()),t.serverName=i.attributes.name,t.chunkUploaded=1}})}).on("fileuploadprocessalways",function(t,i){e.each(i.files,function(e,t){var i=t.context;void 0!==i&&(t.preview&&(i.find(".image").append(t.preview),i.find(".preview").removeClass("file-preview").addClass("image-preview")),t.error&&(i.removeClass("added process").addClass("error"),i.find(".error-message").text(t.error),i.find(".button-start").remove()))})}).on("fileuploadprogress",function(t,i){e.each(i.files,function(e,t){var r=t.context,o=parseInt(i.loaded/i.total*100,10);r.find(".progress-bar").css("width",o+"%")})}).on("fileuploadprogressall",function(e,t){var i=parseInt(t.loaded/t.total*100,10);l.css("width",i+"%")})}):(m.unbind().click(function(){if(!Q("upload"))return r.error(A("NOT_ALLOWED")),!1;e("#newfile").trigger("click")}),a.fileupload({autoUpload:!0,dataType:"json",url:ye(),paramName:"files",maxChunkSize:v.upload.chunkSize}).on("fileuploadadd",function(e,t){m.data(t)}).on("fileuploadsubmit",function(e,t){t.formData=ge("POST",{mode:"upload",path:k.currentPath()}),m.addClass("loading").prop("disabled",!0),m.children("span").text(A("loading_data"))}).on("fileuploadsend",function(e,t){if(!1===r.settings.callbacks.beforeSendRequest(t.type,t.formData))return r.error(A("NOT_ALLOWED")),!1}).on("fileuploadalways",function(e,t){m.removeData().removeClass("loading").prop("disabled",!1),m.children("span").text(A("action_upload"));var i=t.result;if(i&&i.errors&&r.error(A("upload_failed")+"<br>"+K(i.errors[0])),i&&i.data){var o=i.data[0];k.removeElement(o),k.addElements(o,k.currentPath()),v.options.showConfirmation&&r.success(A("upload_successful_file"))}}).on("fileuploadchunkdone",function(e,t){var i=t.result;if(i.data&&i.data[0]){var r=i.data[0];k.removeElement(r),k.addElements(r,k.currentPath())}}).on("fileuploadfail",function(e,t){r.error(A("upload_failed"))}))};!function(){var t=e.Deferred();t.then(function(){return E()}).then(function(){return I()}).then(function(e,t){return N()}).then(function(){return O()}).then(function(){P(function(){F()})}),t.resolve()}(),e(window).resize(r.setDimensions)}}(jQuery),$.fn.richFilemanager=function(e){return this.each(function(){if(void 0==$(this).data("richFilemanager")){var t=new $.richFilemanagerPlugin(this,e);$(this).data("richFilemanager",t)}})},window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""));